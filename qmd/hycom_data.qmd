---
title: "Modeled Currents"
author: "Sebastian Di Geronimo"
date: 2025-08-06
format: html
editor: source
---

# 1.0 ---- Summary of Document ----

Host Website: <https://www.hycom.org/>
Catalog: <https://ncss.hycom.org/thredds/catalog.html>
Forum for HYCOM: <https://groups.google.com/a/hycom.org/g/forum>
- help documents

## HYCOM-TSIS 1/100º Gulf of Mexico Reanalysis

<https://www.hycom.org/data/gomb0pt01/gom-reanalysis>

Uses Tendral Statistical Interpolation (T-SIS) package to get high resolution
(Srinivasan et al., 2022, www.tendral.com/tsis). multivariate linear statistical 
estimation given a predicted ocean state and observations

Assimilates
- SLA (T/P, JASON 1 and 2, Envisat, GFO and Cyrosat)
- SST (GHRSST and AVHRR)
- Temp/salinity from ARGO floats


Hourly 2001-01-01 to "Present" (2-3 month delay)
- 40 depth layers
- velocity in u, v 
- vertical velocity in w

For addtional documentation:
<https://www.hycom.org/hycom/documentation>


## HYCOM and NCODA Gulf of Mexico 1/25° Analysis
This is some information about a higher resolution model from HYCOM and NCODA
<https://portal.secoora.org/#module-metadata/8bc4c4e7-ddbb-462e-a07c-c0e0d5fbeb3f>

Hourly from 2017 - Jan 2023 at 1/25°
Variables:
- sea water velocity
- water surface elevation
- salinity
- water temperature


## CNAPS

Coupled Northwest Atlantic Prediction System
May 1, 2016 20:00 (EDT) - Jul 2, 2019 17:00 (EDT)
3 hours
<https://portal.secoora.org/#metadata/4bc223e1-6b14-46f5-9832-f8e9ff061a36/13cee4ae-2d36-454c-a6bc-1dcc223d819c>
Variables:
- northward velocity
- bottom U-momentum stress
- bottom V-momentum stress
- currents
- eastward velocity
- evaporation rate
- free surface
- net latent heat flux
- net longwave radiation flux
- net sensible heat flux
- potential temperature
- rain fall rate
- salinity
- solar shortwave radiation flux
- surface net heat flux
- surface net salt flux
- surface U-momentum stress
- surface V-momentum stress
- vertical momentum component
- wind induced mean wavelength
- wind induced significant wave height
- wind induxed wave direction


## SABGOM
South Atlantic Bight and Gulf of Mexico
Apr 29, 2016 20:00 (EDT) - Dec 25, 2017 19:00 (EST)
3 hours
<https://portal.secoora.org/#metadata/9cf0615d-948a-46f8-ad4b-73c887b9eaa3/ab6cb99f-ed82-46cd-a0c7-cf1b2069adfc>
incorporating the ROMS model for circulation, the WRF model for atmospheric 
circulation, the SWAN model for surface waves




# 2.0 ---- Setup ----


## 2.1 Load Libraries

```{r setup, include=FALSE}
if (!nzchar(system.file(package = "librarian"))) 
  install.packages("librarian")

librarian::shelf(
  quiet = TRUE,
  librarian, conflicted, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  
  # additional
  ncdf4, sf, metR, tidyterra, oce
)

conflicts_prefer(
  dplyr::filter(), 
  dplyr::select(),
  tidyr::extract()
  )
  
shelf(terra)

source(here("R", "aviso_functions.R"))
```

## 2.2 Cruise Dates

```{r ctd-dates}
# minimum year to extract from
min_year <- 2015
hours_of_day <- c(12, 23)

# previous days to load from last CTD data
prev_day <- 14

if (exists("cloud_dir")) {
  min_max_date <-
    here(cloud_dir, "data", "raw") %>%
    dir_ls(regexp = "ctd_min_max_date")  %>%
    read_csv(show_col_types = FALSE) %>% 
    mutate(
      year = year(max_time)
    )  %T>%
    print()
} else {
  min_max_date <-
    rstudioapi::selectFile() %>%
    read_csv(show_col_types = FALSE) %>% 
    mutate(
      year = year(max_time)
    ) %T>%
    print()
} 


cruise_ids <- c("WS16004", "WS17030", "WS17212", "WS18008", "WS20342", "WS21212")

```



# 3.0 ---- Download HYCOM-TSIS Data ----

Info: <https://www.hycom.org/data/gomb0pt01/gom-reanalysis>
From: <https://tds.hycom.org/thredds/catalog/datasets/GOMb0.01/reanalysis/data/catalog.html>

Help for download flags: <https://docs.unidata.ucar.edu/tds/current/userguide/ncss_grid.html>
- dateTime has the form: '-'? yyyy '-' mm '-' dd 'T' hh ':' mm ':' ss ('.' s+)? (zzzzzz)?

Base URL:
https://ncss.hycom.org/thredds/ncss/datasets/GOMb0.01/reanalysis/data/YYYY/xxx_archv.YYYY_DDD_HH_NN.nc

Experiment Numbers:
This part `xxx_archv.YYYY_DDD_HH_NN.nc` is described here
xxx: experiment number (i.e. 010, 023 or 026 for date ranges)
YYYY: year
DDD: day (julian day)
HH: hour
NN: Netcdf type (i.e. 2d (surface) or 3z (with depth))

HYCOM-TSIS GOMb0.01:
010_archv.YYYY_DDD_HH_NN.nc: 2001_001_00 to 2017_152_18
023_archv.YYYY_DDD_HH_NN.nc: 2017_152_19 to 2024_032_18
026_archv.YYYY_DDD_HH_NN.nc: 2024_001_19 to *PRESENT*


Parameters used in link for 3z:
- variables
  - var=salinity&
  - var=u&
  - var=v&
  - var=w_velocity&
  - var=water_temp
- lat/lon
  - north=26.4375&
  - west=-83.8125&
  - east=-78.3125&
  - south=22.8125
- horizStride=1
  - number of data points to skip along horiztonal (x and y)
- vertStride=1
  - number of data points to skip along vertical (z)
- time=2017-01-02T10%3A01%3A52.500Z
  - yyyy-mm-ddThh:mm::ss
  - %3A is : (colon in URL encoding)
- vertCoord=0.0
  - single level 0.0, 2.0, 4.0, ..., 5000 m

- accept=netcdf4
  - type of netcdf (netcdf or netcdf4)


Depth options (40): 
  0.0 2.0 4.0 6.0 8.0 10.0 12.0 15.0 20.0 25.0 30.0 35.0 40.0 45.0 
  50.0 60.0 70.0 80.0 90.0 100.0 125.0 150.0 200.0 250.0 300.0 350.0 400.0 
  500.0 600.0 700.0 800.0 900.0 
  1000.0 1250.0 1500.0 2000.0 2500.0 3000.0 4000.0 5000.0


## 3.1 Constants
```{r constants}
# ---- catalog url ---- #
hycom_url <- "https://tds.hycom.org/thredds/catalog/datasets/GOMb0.01/reanalysis/data/"

# ---- constants ---- #
vert    <- format(0, nsmall = 1) # depth
horizon <- 1 # number of data points to skip, this save data space

lat_lon <- list(
  # long
  "xmin" = -83.8125,
  "xmax" = -78.3125,
  #lat
  "ymin" = 22.8125,
  "ymax" = 26.4375
)
```

## 3.2 Search HYCOM For Data Files

This search only needs to happen once to get the file name. 

To subset the data, change the info in constants 

```{r search-hycom}
if (exists("cloud_dir")) {
  hycom_info <-
    here(
      cloud_dir,
      "data",
      "hycom_100deg_download_instructions.csv"
      )
} else {
  hycom_info <- 
    here(
    rstudioapi::selectDirectory(),
    "data",
    "hycom_100deg_download_instructions.csv"
  )
}

# TODO: replace search with function `hycom_search()`
if (!file_exists(hycom_info)) {
  shelf(rvest)
  # specific url base for searching the database
  specifics <-
    paste0(
      "var=salinity&var=u&var=v&var=w_velocity&var=water_temp&",
      "north={lat_lon$ymax}&west={lat_lon$xmin}&east={lat_lon$xmax}&south={lat_lon$ymin}&",
      "disableProjSubset=on&",
      "horizStride={horizon}&",
      "time={date}&",
      "vertCoord={vert}&accept=netcdf4"
    )

  # ---- web searching ---- #

  # ---- search URL for every file
  # selection based on minimum year and hour od day
  search_individual_files <-
    paste0(hycom_url, "catalog.html") %>%
    read_html() %>%
    html_elements("a tt") %>%
    html_text() %>%
    str_subset("\\d{4}") %>%
    str_remove("/") %>%
    as.numeric() %>%
    tibble(file = hycom_url, year = .) %>%
    filter(year >= min_year) %>% # filter year
    mutate(file_yr = glue("{file}{year}/")) %>%
    mutate(
      file_day = map(
        file_yr,
        \(.file) {
          paste0(.file, "catalog.html") %>%
            read_html() %>%
            html_element("body") %>%
            html_table() %>%
            pull(1) %>%
            str_subset(glue("{hours_of_day}_3z\\.nc")) %>%
            tibble(file = .file, day = .) %>%
            mutate(
              part_url = str_extract(file, "datasets/GO.*"),
              file_day = paste0(file, "catalog.html?dataset=", part_url, day)
            )
        }
      )
    ) %T>%
    print()

  # ---- search the file URL for download
  extract_file_location <-
    search_individual_files %>%
    unnest(file_day, names_sep = "_") %T>%
    print() %>%
    # slice(1, .by = year) %>%
    mutate(
      info = map(
        file_day_file_day,
        \(.path) {
          .path %>%
            read_html() %>%
            html_element("body") %>%
            html_element("ol") %>%
            html_text() %>%
            str_extract("NetcdfSubset.*\\.nc") %>%
            str_remove("NetcdfSubset:.*//") %>%
            paste0("https://", ., "/dataset.html")
        }
      )
    ) %>%
    unnest(info) %T>%
    print()

  # ---- extract date from file URL
  extract_date_location <-
    extract_file_location %>%
    mutate(
      date = map(
        info,
        \(.path) {
          .path %>%
            read_html() %>%
            html_element("body") %>%
            html_elements("h3 span") %>%
            html_text() %>%
            str_subset("\\d{4}.*") %>%
            str_replace_all(":", "%3A")
        }
      )
    ) %>%
    unnest(date) %T>%
    print()

  # ---- setup final url before adding constants
  final_download_info <-
    extract_date_location %>%
    mutate(
      .keep = "used",
      date,
      final_path =
        str_remove(info, "grid/") %>%
          str_replace("/dataset.html", "?"),
      final_path = paste0(
        final_path,
        specifics
      ),
      file_name = paste0("hycom_", str_remove(date, "T.*"), ".nc4"),
      file_name = str_replace_all(file_name, "-", "_")
    ) %T>%
    print()
  
  # ---- write final info to file to save time
  write_csv(final_download_info, hycom_info)
  
  unshelf(rvest)
  
} else {
  print(
    glue("HYCOM search previously completed on ", 
         "{file_info(hycom_info)$birth_time}")
    )
  
  final_download_info <- read_csv(hycom_info, show_col_types = FALSE)
}


```


## 3.3 Download HYCOM-TSIS Data

Find file with all URLs to HYCOM Data

```{r download-hycom}
if (exists("cloud_dir")) {
  dwnld_path <- here(cloud_dir, "data", "raw", "hycom")
} else {
  dwnld_path <- here("data", "raw", "hycom")
}

dir_create(dwnld_path)

# long
xmin <- -83.8125
xmax <- -78.3125
#lat
ymin <- 22.8125
ymax <- 26.4375

# apply final search parameters
path_save <- 
  final_download_info %>%
  mutate(
    final_path = map2_chr(
      final_path,
      date,
      \(final, date) {
        glue(final)
      }
    )
  ) %T>%
  print() 
```

### 3.3.2

```{r single-download}
path_save %>% 
  mutate(date2 = str_remove(date, "T.*") %>% ymd()) %$%
  # filter dates
  # filter(date2 %in% min_max_date) %$%
  # slice(1500:1502) %$%
  walk2(
    final_path,
    file_name,
    \(.url, .file_name) {
      print(.url)
      cat("\n\n\n")
      print(.file_name)
      
      if (file_exists(here(dwnld_path, .file_name))) {
         message("File exists. Returning.")
         return()
      }
      
      download.file(
        url      = .url,
        destfile = here(dwnld_path, .file_name),
        method   = "curl"
      )
    }
  )

```

### 3.3.3 Parallel Download

May parallel download data if have access to the `furrr` and `progressr`

```{r parallel-download}
if (FALSE) {
  shelf(progressr, furrr)
  plan(multisession, workers = 5)
  
  
  filt_download <-  
    # filter dates
    path_save %>%
    mutate(date2 = str_remove(date, "T.*") %>% ymd()) %T>%
    # filter(date2 %in% min_max_date) %$%
    # slice(1:500) %T>% 
    print()
  
  with_progress({
    
    p <- progressor(steps = nrow(filt_download))
    
    filt_download %$%
      future_walk2(
        final_path,
        file_name,
        \(.url, .file_name) {
          p()
          print(.url)
          cat("\n\n\n")
          print(.file_name)
           if (file_exists(here(dwnld_path, .file_name))) {
             message("File exists. Returning.")
             return()
           }
           
           download.file(
             url      = .url,
             destfile = here(dwnld_path, .file_name),
             method   = "curl"
           )
          },
          .progress = TRUE)
  })
}
```


# 4.0 Load Dataset

```{r load-data}
# local storage
hycom_path <- here("data", "raw", "hycom") %>%
  dir_ls() %T>% 
  print()

# cloud storage
hycom_path <- here(cloud_dir, "data", "raw", "hycom") %>%
  dir_ls() %T>% {
    print(length(.))
    sample(., 10) %>% print()
  }

# hycom_path <- rstudioapi::selectFile(path = here("..", "misc_ideas", "data", "raw", "hycom"))

cruise_id <- 
  filter(min_max_date, year >= 2015) %>% 
  distinct(cruise_id) %>% 
  pull(cruise_id) %T>%
  print()

# for (i in cruise_id) {
#   
# 
#   # filter CTD dates
#   filt_dates <- 
#     min_max_date %>% 
#     filter(
#       # year == 2018,
#       cruise_id == i
#     ) %>% pull(max_time) %>% 
#     
#     # add all dates from max date minus x days
#     map(
#       \(.x) {
#         as_date((.x-days(prev_day)):.x)
#       }
#     ) %>% 
#     list_c() %T>% 
#     print()
# 
#   hycom_filt <- 
#     hycom_path %>% 
#     tibble(file = .) %>% 
#     mutate(
#       date = str_extract(file, "\\d{4}_\\d{2}_\\d{2}"),
#       date = as_date(date)
#     ) %>% 
#     # filter(date %in% filt_dates) %>% 
#     filter(date == as_date("2018-07-26"))
#     pull(file) %T>% 
#     print()
# }

```


## Load Coast

```{r coast}
# bounding box
lat_lon <- list(
  # long
  "xmin" = -83.8125,
  "xmax" = -78.3125,
  #lat
  "ymin" = 22.8125,
  "ymax" = 26.4375
)

# load coastline
coast <-
  rnaturalearth::ne_coastline(10, returnclass = "sf") %>%
  st_crop(st_bbox(unlist(lat_lon)))
coast

ggplot() +
  geom_sf(data = coast) +
  coord_sf(expand = FALSE) +
  theme_bw()

```


## Create Transects

This is created manually upon first instance if `transect2.shp` doesn't exist.

The points from the SFER/MBON cruise are load and the Florida Keys locations
are extracted. Then manual creation of transects are done. 


```{r create-load-transects}
# set paths to save shapefiles, and animations
shp_save <- here("data", "raw", "shapefiles")
dir_create(shp_save)

transect_file <- here(shp_save, "transects2.shp")

# stations_path <- rstudioapi::selectFile() 
stations_path <- 
  here("data", "raw") %>%
  dir_ls(regexp = "station_info")

station <- 
  readxl::read_excel(
    stations_path, 
    .name_repair = janitor::make_clean_names
  ) %>%
  filter(str_detect(geo_loc_name, "(?i)florida keys") & !str_detect(line_id, "PL")) %>%
  select(station_id, station_class, "lon" = mean_lon, "lat" = mean_lat, line_id)

if (file_exists(transect_file)) {
  message("Reading transects shapefile")
  linestring <- st_read(transect_file)
} else {
  
  message("Creating transects.")
  lyr_name <- grep("vel_mag", names(multi_rast), value = TRUE)[1]

  polyline <-
    ((mapview::mapView(multi_rast, layer = lyr_name) +
      mapview::mapview(coast)) +
      mapview::mapview(station, xcol = "lon", ycol = "lat")
    ) %>%
    mapedit::editMap()

  linestring <- polyline$finished

  names(linestring) <- c("id", "type", "geometry")

  message(paste0("Saving transects as `", basename(transect_file), "`."))

  # save shapefile
  st_write(
    linestring,
    transect_file
  )
}

mapview::mapview(linestring)
```


## Load Multiple HYCOM-TSIS Data

```{r terra}
if (FALSE) {
# hycom_paths <- 
#   hycom_path[1] %>%
#   dir_ls() %T>% 
#   print() 

# for (paths in hycom_paths) {
for (paths in hycom_filt) {
  # read netcdf
  # hy_rast <- rast(hycom_paths[1])
  hy_rast <- rast(paths)

  # extract date in the format as days since Dec 31, 1990
  hy_date <-
    lubridate::as_date(
      as.numeric(str_extract(names(hy_rast)[1], "MT=(.*)", 1)),
      origin = as_date("1900-12-31")
    )

  # rename grids
  names(hy_rast) <- c("sal", "u", "v", "w", "temp")

  # add velocity magnitude
  hy_rast <-
    hy_rast %>%
    tidyterra::mutate(vel_mag = sqrt(u^2 + v^2))

  # add date to all layers
  terra::time(hy_rast) <- rep(hy_date, nlyr(hy_rast))
  
  # convert spatRaster to data.frame
  hy_dat <-
    hy_rast %>%
    terra::as.data.frame(xy = TRUE, date = hy_date) %>%
    # rename spatial
    rename("lon" = x, "lat" = y) %>%
    relocate(date, .before = 1) %T>% 
    print()

  # spatial extent for plotting
  xy_ext <- ext(hy_rast)

  # plot
  plt <-
    ggplot() +

    # spatRaster
    tidyterra::geom_spatraster(data = hy_rast, aes(fill = vel_mag)) +
    
    geom_sf(data = coast) +
    
    # transect lines
    # geom_sf(data = linestring, color = "red", alpha = 0.5) +

    # velocity vectors
    metR::geom_arrow(
      data = hy_dat,
      skip = 10,
      aes(
        x     = lon,
        dx    = u ,
        y     = lat,
        dy    = v,
        color = vel_mag
      ),
      # arrow     = arrow(length = unit(0.15/2, "cm")), # adjust arrow size
      size = 0.25,                              # adjust arrow thickness
      na.rm = TRUE
    ) +
    labs(x = NULL, y = NULL, title = glue("Date: {hy_date}")) +
    scale_fill_gradientn(
      name     = "Current",
      colours  = oceColorsVelocity(120), # edit colors
      limits   = c(0, 2),
      breaks   = seq(0.0, 2, 0.25),
      rescaler = ~ scales::rescale_mid(.x, mid = 0.5),
      oob      = scales::oob_squish,
      guide    = guide_colorbar(
        barwidth       = 0.8,
        barheight      = 10,
        title          = expression(Current ~ speed ~ (m ~ s^{-1})),
        title.position = "right",
        title.hjust    = 0.5,
        title.theme    = element_text(angle = 90)
      )
    ) +
    scale_color_gradientn(
      name     = "Current",
      colours  = oce.colorsPalette(120), # edit colors
      limits   = c(0, 2),
      breaks   = seq(0.0, 2, 0.25),
      rescaler = ~ scales::rescale_mid(.x, mid = 0.5),
      oob      = scales::oob_squish,
      guide    = guide_colorbar(
        barwidth       = 0.8,
        barheight      = 10,
        # title          = expression(Velocity ~ magnitude ~ (m ~ s^{-1})),
        title          = expression( ~ speed ~ (m ~ s^{-1})),
        title.position = "right",
        title.hjust    = 0.5,
        title.theme    = element_text(angle = 90)
      )
    ) +
    coord_sf(expand = FALSE, ylim = xy_ext[3:4], xlim = xy_ext[1:2]) +
    theme_bw()
  print(plt)
}


# shelf(camcorder)
camcorder::gg_record(here("data", "plots", "camcorder_xxx"), dpi = 600)
camcorder::gg_stop_recording()
camcorder::gg_playback(
  frame_duration       = 0.7, 
  first_image_duration = 10,
  last_image_duration  = 10,
  last_as_first        = FALSE,
  dpi = 600
  )
}
```


```{r terra-cam}
tictoc::tic()
# hycom_paths <- 
#   hycom_path[1] %>%
#   dir_ls() %T>% 
#   print() 

hycom_path_t <- 
  hycom_path %>% 
  tibble(file = .) %>% 
  mutate(
    date = str_extract(file, "\\d{4}_\\d{2}_\\d{2}"),
    date = as_date(date)
  )

for (i in cruise_id) {
  

  # filter CTD dates
  filt_dates <- 
    min_max_date %>% 
    filter(cruise_id == i) %>% 
    pull(max_time) %>% 
    # add all dates from max date minus x days
    map(\(.x) as_date((.x-days(prev_day)):.x)) %>% 
    list_c() %T>% 
    print()

  # select dates that correspond the cruise dates  
  hycom_filt <- 
    hycom_path_t %>% 
    filter(date %in% filt_dates) %>% 
    mutate(
      file_name = glue("{i}_{date}"),
      file_name = str_replace_all(file_name, "-", "_")
    ) %T>% 
    print()

  # cruise id for folder
  folder_name <- here("data", "plots", glue("camcorder_{i}"))

  if (dir_exists(folder_name)) {
    message(glue("Cruise {i} already exists. Skipping!\n\n----\n"))  
    next
  }


  camcorder::gg_record(folder_name, dpi = 600)

  for (paths in pull(hycom_filt, file)) {

    # read netcdf
    hy_rast <- rast(paths)
  
    # extract date in the format as days since Dec 31, 1990
    hy_date <-
      lubridate::as_date(
        as.numeric(str_extract(names(hy_rast)[1], "MT=(.*)", 1)),
        origin = as_date("1900-12-31")
      )
  
    # rename grids
    names(hy_rast) <- c("sal", "u", "v", "w", "temp")
  
    # add velocity magnitude
    hy_rast <-
      hy_rast %>%
      tidyterra::mutate(vel_mag = sqrt(u^2 + v^2))
  
    # add date to all layers
    terra::time(hy_rast) <- rep(hy_date, nlyr(hy_rast))
    
    # convert spatRaster to data.frame
    hy_dat <-
      hy_rast %>%
      terra::as.data.frame(xy = TRUE, date = hy_date) %>%
      # rename spatial
      rename("lon" = x, "lat" = y) %>%
      relocate(date, .before = 1) 
  
    # spatial extent for plotting
    xy_ext <- ext(hy_rast)
  
    # plot
    plt <-
      ggplot() +
  
      # spatRaster
      tidyterra::geom_spatraster(data = hy_rast, aes(fill = vel_mag)) +
      
      geom_sf(data = coast) +
      
      # TODO: add transect
      # transect lines
      # geom_sf(data = linestring, color = "red", alpha = 0.5) +
  
      # velocity vectors
      metR::geom_arrow(
        data = hy_dat,
        skip = 10,
        aes(
          x     = lon,
          dx    = u ,
          y     = lat,
          dy    = v,
          color = vel_mag
        ),
        # arrow     = arrow(length = unit(0.15/2, "cm")), # adjust arrow size
        size = 0.25,                              # adjust arrow thickness
        na.rm = TRUE
      ) +
      labs(x = NULL, y = NULL, title = glue("{i}: {hy_date}")) +
      scale_fill_gradientn(
        name     = "Current",
        colours  = oceColorsVelocity(120)[-c(48:73)], # edit colors
        limits   = c(0, 2),
        breaks   = seq(0.250, 2, 0.25),
        rescaler = ~ scales::rescale_mid(.x, mid = 0.5),
        oob      = scales::oob_squish,
        guide    = guide_colorbar(
          barwidth       = 0.8,
          barheight      = 10,
          title          = expression(Current ~ speed ~ (m ~ s^{-1})),
          title.position = "right",
          title.hjust    = 0.5,
          title.theme    = element_text(angle = 90)
        )
      ) +
      scale_color_gradientn(
        name     = "Current",
        colours  = oce.colorsPalette(120)[-c(48:72)], # edit colors
        limits   = c(0, 2),
        breaks   = seq(0.0, 2, 0.25),
        rescaler = ~ scales::rescale_mid(.x, mid = 0.5),
        oob      = scales::oob_squish,
        guide    = guide_colorbar(
          barwidth       = 0.8,
          barheight      = 10,
          # title          = expression(Velocity ~ magnitude ~ (m ~ s^{-1})),
          title          =  expression(Current ~ speed ~ (m ~ s^{-1})),
          title.position = "right",
          title.hjust    = 0.5,
          title.theme    = element_text(angle = 90)
        )
      ) +
      coord_sf(expand = FALSE, ylim = xy_ext[3:4], xlim = xy_ext[1:2]) +
      theme_bw()
    print(plt)
  }
  
  camcorder::gg_playback(
    frame_duration       = 0.7, 
    first_image_duration = 10,
    last_image_duration  = 10,
    last_as_first        = FALSE,
    dpi                  = 600,
    stoprecording        = TRUE,
    playback             = FALSE
    )

  # rename file
  folder_name %>% 
    dir_ls(regexp = "png") %>% 
    bind_cols(
      hycom_filt , 
      "old_file" = .
    ) %>%
    mutate(
      file_name = here(dirname(old_file), glue("{file_name}.png")),
    ) %$%
    map2(
      old_file,
      file_name,
      \(x, y) {
        file_move(x, y)
      }
    )
  
  # rename gif
  folder_name %>% 
    dir_ls(regexp = "gif") %>% 
    file_move(here(dirname(.), glue("{i}_currents.gif")))
  
}

tictoc::toc()
```


## Move resized Images and Gifs

```{r gif-move}
if (FALSE) {
  # move "resized" folders
  resized <- here("data", "plots", "resized")
  dir_create(resized)
  here("data", "plots") %>% 
    dir_ls(regexp = "camcorder_") %>% 
    dir_ls(regexp = "resize", recurse = 1, type = "directory") %>%
    tibble(old_path = .) %>% 
    mutate(
      new_path = str_extract(old_path, "[A-Z]{2,3}\\d{3,6}"),
      new_path = here(resized, glue("{new_path}_resize"))
      ) %T>%
    print() %$%
    
    map2(
      old_path,
      new_path,
      \(.x, .y) {
        # as.character(.x)
        if (!dir_exists(.y)) {
          dir_copy(.x, .y)
        }
        dir_delete(.x)
      }
    )
  
  # move gif
  gif_folder <- here("data", "plots", "vid")
  dir_create(gif_folder)
  here("data", "plots") %>% 
    dir_ls(regexp = "camcorder_") %>% 
    dir_ls(regexp = "gif", recurse = 1) %T>%
    print() %>% 
    file_move(gif_folder)
}
```

## Move gif to video folder in cloud

Only needed sparingly

```{r terra-cam}
# use when moved data to cloud and need to separate gif to video folder
if (FALSE) {
  # move gif in cloud from images to vid folder
  here(cloud_dir, "hycom_vid_img", "vid") %>%
    dir_create()
  
  cloud_dir %>%
    dir_ls(regexp = "hycom") %>%
    dir_ls(regexp = "img$") %>%
    dir_ls(regexp = "gif", recurse = 1) %>%
    file_move(here(cloud_dir, "hycom_vid_img", "vid"))

  
  # delete resize folder in cloud
   # cloud_dir %>%
   #  dir_ls(regexp = "hycom") %>%
   #  dir_ls(regexp = "img$") %>%
   #  dir_ls(regexp = "resize", recurse = 1) %>% 
   #  dir_delete()
  
}
```

# `ncdf4`: Load One HYCOM-TSIS File 

```{r netcdf4-one}
# hycom_dat <- ncdf4::nc_open(hycom_path[10])
hycom_dat <- ncdf4::nc_open(hycom_path)

hycom_dat
names(hycom_dat)
hycom_dat$var %>%
  names()
names(hycom_dat$dim)

if (length(ncvar_get(hycom_dat, "Depth")) > 1) {
  # if multiple depths
  message("HYCOM data has multiple depths (m).")
  hycom_u <- ncvar_get(hycom_dat, "u")[, , 1]
  hycom_v <- ncvar_get(hycom_dat, "v")[, , 1]
} else {
  # if single depth
  message("HYCOM data has one depth (m).")
  hycom_u <- ncvar_get(hycom_dat, "u") 
  hycom_v <- ncvar_get(hycom_dat, "v") 
}

lat  <- ncvar_get(hycom_dat, "Latitude")
lon  <- ncvar_get(hycom_dat, "Longitude")

 # create grid data
      hycom_grid <-
        expand.grid(lon = lon, lat = lat) %>%
        mutate(
          # adt     = as.vector(adt), # absolute dynamic topography
          hycom_v    = as.vector(hycom_v), # north geostrophic velocity
          hycom_u    = as.vector(hycom_u), # east geostrophic velocity
          vel_mag = sqrt(hycom_v^2 + hycom_u^2) # calculate current velocity
        )

      # dat_grid_temp[[i]] <- ssh_grid

ncvar_get(hycom_dat, "MT") %>% 
  lubridate::as_date(origin = "1900-12-31")
  

nc_close(hycom_dat)
```

```{r netcdf4-multi}
# hycom_paths <- 
#   hycom_path %>%
#   dir_ls() %T>% 
#   print() 


hy2 <- hycom_load(hycom_paths[1])

# spacing between vectors to plot 
slice_by <- 200

# length of arrows
length_divide <-  2

for (paths in hycom_path[1]) {
  # load hycom data
  hy2 <- hycom_load(paths)
  # hy2 <- hycom_load(hycom_path[1])
  
  # select subset of data by number of slices
  vel_vect <- slice(hy2$tibble, seq(1, n(), by = slice_by))

  # extract spatial extent of data
  xlim <- range(hy2$tibble$lon) # lon
  ylim <- range(hy2$tibble$lat) # lat

  plt <-
    ggplot() +
    geom_tile(data = hy2$tibble, aes(x = lon, y = lat, fill = vel_mag)) +
    # velocity vectors
    geom_segment(
      data = vel_vect,
      aes(
        x     = lon,
        xend  = lon + hycom_u / length_divide,
        y     = lat,
        yend  = lat + hycom_v / length_divide,
        color = vel_mag
      ),
      arrow = arrow(length = unit(0.15 / 2, "cm")), # adjust arrow size
      linewidth = 0.25, # adjust arrow thickness
      na.rm = TRUE
    ) +
    labs(x = NULL, y = NULL) +
    facet_wrap(~date) +
    scale_fill_viridis_b(
      breaks = seq(0, 2, by = 0.25),
      guide = guide_colorbar(
        barwidth = 0.8,
        barheight = 10,
        title = expression(Velocity ~ magnitude ~ (m ~ s^{
          -1
        })),
        title.position = "right",
        title.hjust = 0.5,
        title.theme = element_text(angle = 90)
      )
    ) +
    scale_color_viridis_b(
      option = "magma",
      breaks = seq(0, 2, by = 0.25),
      guide = guide_colorbar(
        barwidth = 0.8,
        barheight = 10,
        title = expression(Velocity ~ magnitude ~ (m ~ s^{
          -1
        })),
        title.position = "right",
        title.hjust = 0.5,
        title.theme = element_text(angle = 90)
      )
    ) +
    theme_bw() +
    coord_cartesian(expand = FALSE, ylim = ylim, xlim = xlim)
  print(plt)
}

# shelf(camcorder)
# camcorder::gg_record(here("data", "plots", "camcorder2"))
# camcorder::gg_stop_recording()
# camcorder::gg_playback(frame_duration = 0.7)
```


# WIP: Plot Streamlines

Streamlines show steady field as in where is the water going 

```{r}
shelf(metR, tidyterra)
ggplot() +
geom_streamline(data = hy2$tibble, 
                        aes(x = lon, y = lat, dx = hycom_u, dy = hycom_v, 
                            # color = sqrt(..dx..^2 + ..dy..^2), 
                            # color = sqrt(after_stat(dx^2) + after_stat(dy^2)), 
                            # alpha = ..step..
                            ),
                      L = 2, res = 2, n = 40, 
                      arrow = NULL, lineend = "round")

ggplot() +
  geom_tile(data = hy2$tibble, aes(x = lon, y = lat, fill = vel_mag)) +
  # velocity vectors
  geom_segment(
    data = vel_vect,
    aes(
      x     = lon, 
      xend  = lon + hycom_u/length_divide, 
      y     = lat, 
      yend  = lat + hycom_v/length_divide, 
      color = vel_mag
      ),
    arrow     = arrow(length = unit(0.15/2, "cm")), # adjust arrow size
    linewidth = 0.25,                              # adjust arrow thickness
    na.rm     = TRUE
  ) +
  # scale_fill_
  theme_bw() +
  facet_wrap(~date) +
  scale_fill_viridis_b(breaks = c(0.25, seq(0, 2, by = 0.5))) +
  scale_color_viridis_b(option = "magma", breaks = c(0.25, seq(0, 2, by = 0.5))) +
  coord_cartesian(expand = FALSE, ylim = ylim, xlim = xlim)
```


```{r}
st_make_grid
shelf(data.table)
data(geopotential)
test <- data.table::copy(geopotential)[date == date[1]]
test[, gh.z := Anomaly(gh), by = .(lat)]
test[, c("u", "v") := GeostrophicWind(gh.z, lon, lat)]

ggplot(test, aes(lon, lat)) +
    geom_contour2(aes(z = gh.z), xwrap = c(0, 360)) +
    geom_streamline(aes(dx = dlon(u, lat), dy = dlat(v)), L = 60,
                    xwrap = c(0, 360))

test %>%
  mutate(
    .keep = "used",
    d2 = dlon(u, lat)
  ) %>%
    arrange(d2)
```


```{r}
hycom_sf <- 
  hy2$tibble %>% 
  st_as_sf(coords = c("lon", "lat")) %>%
  st_set_crs(4326) %T>% 
  print()

hycom_sf %>%
  sf::st_bbox()


hycom_grid <- 
  hycom_sf %>% 
  st_make_grid(n = c(100, 100)) %>%
  st_sf() %T>% 
  print()

ggplot() +
  geom_sf(data = hycom_grid) +
  # geom_sf(data = wio, fill = "lightgrey", col = "black") +
  # coord_sf(ylim = c(-12.5, -4.5), xlim = c(36, 48)) +
  theme_bw() +
  theme(axis.text = element_text(size = 12, colour = 1))

hycom_grided <- 
  hycom_grid %>% 
  mutate(id = 1:n(), 
         contained = lapply(st_contains(st_sf(geometry),hycom_sf),identity),
         obs = sapply(contained, length),
         u = sapply(contained, function(x) {median(hycom_sf[x,]$hycom_u, na.rm = TRUE)}),
         v = sapply(contained, function(x) {median(hycom_sf[x,]$hycom_v, na.rm = TRUE)})
         ) %T>% 
  print()

hycom_grided2 <- 
  hycom_grided %>% 
  select(obs, u, v) %>% 
  na.omit() %T>% 
  print()


## obtain the centroid coordinates from the grid as table
coordinates <- 
  hycom_grided2 %>% 
  st_centroid() %>% 
  st_coordinates() %>% 
  as_tibble() %>% 
  rename(x = X, y = Y) %T>% 
  print()

## remove the geometry from the simple feature of gridded drifter dataset
st_geometry(hycom_grided2) <- NULL

## stitch together the extracted coordinates and drifter information int a single table for SE monsoon season
current_gridded <- 
  coordinates %>% 
  bind_cols(hycom_grided2) %T>% 
  print()
```


```{r}
shelf(oce)

## interpolate the U component
u_se <-  interpBarnes(x = current_gridded$x, y = current_gridded$y, z = current_gridded$u)
v_se <-  interpBarnes(x = current_gridded$x, y = current_gridded$y, z = current_gridded$v)

## obtain dimension that determine the width (ncol) and length (nrow) for tranforming wide into long format table
dimension_u <- data.frame(lon = u_se$xg, u_se$zg) %>% dim()
dimension_v <- data.frame(lon = v_se$xg, v_se$zg) %>% dim()

## make a U component data table from interpolated matrix
u_tb <-
  data.frame(
    lon = u_se$xg,
    u_se$zg
  ) %>%
  gather(key = "lata", value = "u", 2:dimension_u[2]) %>%
  mutate(lat = rep(u_se$yg, each = dimension_u[1])) %>%
  select(lon, lat, u) %>%
  as_tibble() %T>% 
  print()

## make a V component data table from interpolated matrix
v_tb <-
  data.frame(
    lon = v_se$xg,
    v_se$zg
  ) %>%
  gather(key = "lata", value = "v", 2:dimension_v[2]) %>%
  mutate(lat = rep(v_se$yg, each = dimension_v[1])) %>%
  select(lon, lat, v) %>%
  as_tibble() %T>% 
  print()


uv.se <- 
  u_tb %>% 
  bind_cols(v_tb %>% select(v)) %>% 
  mutate(vel = sqrt(u^2+v^2)) %T>% 
  print()
```


```{r}
ggplot() +
  geom_raster(data = uv.se, aes(x = lon, y = lat, fill = vel), interpolate = TRUE)+
  geom_segment(data = uv.se, aes(x = lon, xend = lon + u/1.2, y = lat, yend = lat+v/1.2), 
               arrow = arrow(angle = 20, length = unit(.2, "cm"), type = "open"))+
  # geom_sf(data = wio,fill = "lightgrey", col = "black")+
  # coord_sf(ylim = c(-12.5,-4.5), xlim = c(38, 48))+
  scale_fill_gradientn(name = "Current",colours = oceColorsVelocity(120), 
                       limits = c(0,1.6), breaks = seq(0.1,1.6,.3),
                       guide = guide_colorbar(barwidth = .8, barheight = 15,
                                              title = expression(Current~speed~(ms^{-1})), 
                                              title.position = "right", title.hjust = .5, 
                                              title.theme = element_text(angle = 90)))+
  theme_bw() +
  theme(legend.position = "right",
        legend.key.height = unit(1.4, "cm"), 
        legend.background = element_blank(),
        axis.text = element_text(size = 12, colour = 1))+
  labs(x = "", y = "")
```


```{r}
ggplot() +
  metR::geom_contour_fill(
    data = uv.se, aes(x = lon, y = lat, z = vel),
    na.fill = TRUE, bins = 70
  ) +
  metR::geom_streamline(
    data = uv.se,
    aes(x = lon, y = lat, dx = u, dy = v),
    L      = 0.2, 
    res    = 3, 
    n      = 40, 
    jitter = 4
  ) +
  # geom_sf(data = wio,fill = "lightgrey", col = "black")+
  # coord_sf(ylim = c(-12.5,-4.5), xlim = c(38, 48))+
  scale_fill_gradientn(
    name    = "Current", 
    colours = oceColorsVelocity(120),
    limits  = c(0, 2), 
    breaks  = seq(0.1, 2, .3),
    guide   = guide_colorbar(
      barwidth       = 0.8, 
      barheight      = 15,
      title          = expression(Current ~ speed ~ (ms^{-1})),
      title.position = "right", 
      title.hjust    = 0.5,
      title.theme    = element_text(angle = 90)
    ),
    oob = scales::oob_squish
  ) +
  theme_bw() +
  theme(
    legend.position   = "right",
    legend.key.height = unit(1.4, "cm"),
    legend.background = element_blank(),
    axis.text         = element_text(size = 12, colour = 1)
  ) +
  labs(x = "", y = "")
```












```{r}
ggplot() +
  tidyterra::geom_spatraster(data = test_rast, aes(fill = vel_mag)) +
  
  # geom_raster(data = hy2$tibble, aes(x = lon, y = lat, fill = vel_mag), color = NA,
  #           interpolate = TRUE) +
  # velocity vectors
  geom_streamline(
    # data = slice(test_dat, seq(1, n(), by = 100)),
    data = test_dat,
    # skip = 10,
    aes(
      x     = lon,
      dx  = hycom_u/length_divide,
      # xend  = lon + hycom_u/length_divide,
      y     = lat,
      dy  = hycom_v/length_divide,
      # yend  = lat + hycom_v/length_divide,
      color = vel_mag
      ),
    # arrow     = arrow(length = unit(0.15/2, "cm")), # adjust arrow size
    # linewidth = 0.25,                              # adjust arrow thickness
    na.rm     = TRUE,
       L      = 0.2, 
    res    = 3, 
    n      = 40, 
    jitter = 4
  ) +
  # scale_fill_
  theme_bw() +
  # facet_wrap(~date) +
  scale_fill_gradientn(
    name    = "Current", 
    colours = oceColorsVelocity(120),
    limits  = c(0, 2), 
    breaks  = seq(0.1, 2, .3),
    guide   = guide_colorbar(
      barwidth       = 0.8, 
      barheight      = 10,
      title          = expression(Current ~ speed ~ (ms^{-1})),
      title.position = "right", 
      title.hjust    = 0.5,
      title.theme    = element_text(angle = 90)
    ),
    # na.value = 'salmon',
    oob = scales::oob_squish
  ) +
  # scale_fill_viridis_b(breaks = c(0.25, seq(0, 2, by = 0.5))) +
  scale_color_viridis_b(option = "magma", breaks = c(0.25, seq(0, 2, by = 0.5))) +
  # coord_cartesian(expand = FALSE, ylim = ylim, xlim = xlim) +
  coord_sf(expand = FALSE, ylim = ylim, xlim = xlim) +
  labs(x = NULL, y = NULL)

```

