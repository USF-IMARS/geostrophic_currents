---
title: "Extract Dates from All CTD Data"
author: "Sebastian Di Geronimo"
date: 2025-08-07
format: html
editor: source
---



# ---- Summary of Document ----

Load all CTD data and extract the min and max dates for all CTD data




# ---- Setup ----


## Load Libraries

```{r setup, include=FALSE}
if (!nzchar(system.file(package = "librarian"))) 
  install.packages("librarian")

librarian::shelf(
  quiet = TRUE,
  librarian, conflicted, ggplot2, tibble, tidyr, readr, purrr, dplyr, stringr,
  forcats, lubridate, glue, fs, magrittr, here,
  
  # additional
)

conflicts_prefer(
  dplyr::filter(), 
  dplyr::select()
  )



# set paths to downloaded data, ffmpeg, and animation
path_save <- here("data", "raw", "copernicus")


```

# Load CTD Data from Box

```{r load-ctd}
# path_save <- rstudioapi::selectDirectory()

path_save <- "C:/Users/sebastian15/Box/mbon_imars_cruises/ctd_data/cleaned_ctd_data"

ctd_dat <- 
  path_save %>% 
  dir_ls() %>% 
  tibble(file = .) %>% 
  # slice(1:4) %>%
  mutate(
    data = imap(
      file, 
      \(.x, idx) {
        print(basename(.x))
        cruise <- # fix cruise WB22212
          basename(.x) %>% 
          tools::file_path_sans_ext() %>%
          str_replace("WS", "WB")
        
        x <- read_csv(.x, show_col_types = FALSE) %>% 
          select(cruise_id, time, station) %>%
           mutate(
             time = as_date(time),
             
             # fix station names with:
             # leading `.` and `00`
             # replace `_` with `.`
             # rename all instances of `Lk` to `21Lk`
             station2 = str_remove(station, cruise),
             station2 = str_remove(station2, "^\\."),
             station2 = str_remove(station2, "^0{1,3}"),
             station2 = str_replace(station2, "(_)", "."),
             station2 = str_replace(station2, ".*LK.*", "21LK")
           ) %>% 
          # filter for keys stations that are expected to be CTDs
          filter(station2 %in% c("WS", "MR", "21LK", seq(1:24), "9.5")) %>% 
          mutate(
            min_time = min(time, na.rm = TRUE),
            max_time = max(time, na.rm = TRUE),
          ) %>% 
          # filter where time matches min?max time
          filter(
          .by = cruise_id,
          time == min_time | time == max_time
          ) %>% 
          mutate(
            station2 = as.character(station2),
            station = as.character(station)
          ) %>%
          distinct()
        
        return(x)
      }
      )
  )

```

# Save Extracted Dates

```{r save-dates}
min_max_date <- 
  ctd_dat %>% 
  unnest(data) %>% 
  select(cruise_id, min_time, max_time) %>% 
  distinct()

# save file
save_loc <- rstudioapi::selectDirectory()
save_loc <- here(save_loc, "ctd_min_max_date.csv")
if (!file_exists(save_loc)) {
  message("Saving file")
  write_csv(min_max_date, file = save_loc)
}

```




